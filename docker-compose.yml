version: '3.8'

services:
  # ----------------------------
  # 1. Geth Node
  # ----------------------------
  geth:
    image: ethereum/client-go:stable
    # Removed healthcheck because it causes 'Unhealthy' status on some images
    # Removed --networkid (conflict) and 'personal' API (unavailable)
    command: >
      --dev  --dev.period 0  --http  --http.addr 0.0.0.0  --http.port 8545  --http.vhosts "*"  --http.corsdomain "*"  --http.api "eth,net,web3,debug,txpool"  --ws  --ws.addr 0.0.0.0  --ws.port 8546 --ws.origins "*" --ws.api "eth,net,web3,debug,txpool" --cache 256 --gcmode archive
    ports:
      - "8545:8545" # RPC
      - "8546:8546" # WS
    expose:
      - "8545" # Explicitly tell Coolify this is the main port
    volumes:
      - geth_data:/root/.ethereum
    restart: always
    deploy:
      resources:
        limits:
          memory: 1G

  # ----------------------------
  # 2. Explorer (Alethio Lite)
  # ----------------------------
  explorer:
    image: alethio/ethereum-lite-explorer:latest
    restart: always
    environment:
      - APP_NODE_URL=https://rpc.blockchain.akadal.tr
    ports:
      - "4000:80"
    expose:
      - "80" # Main port for UI

  # ----------------------------
  # 3. Faucet
  # ----------------------------
  faucet:
    build: ./faucet
    restart: always
    environment:
      - RPC_URL=http://geth:8545
      # Using standard dev account if needed manually, but code now uses signer
      - PORT=3000
    ports:
      - "3000:3000"
    expose:
      - "3000"
    depends_on:
      - geth
    deploy:
      resources:
        limits:
          memory: 256M

volumes:
  geth_data:
