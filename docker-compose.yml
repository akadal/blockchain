version: '3.8'

services:
  # ----------------------------
  # 1. Geth Node
  # ----------------------------
  geth:
    image: ethereum/client-go:stable
    command: >
      --dev  --dev.period 0  --http  --http.addr 0.0.0.0  --http.port 8545  --http.vhosts "*"  --http.corsdomain "*"  --http.api "eth,net,web3,debug,txpool"  --ws  --ws.addr 0.0.0.0  --ws.port 8546 --ws.origins "*" --ws.api "eth,net,web3,debug,txpool" --cache 256 --gcmode archive
    ports:
      - "8545:8545"
      - "8546:8546"
    volumes:
      - geth_data:/root/.ethereum
    restart: always
    deploy:
      resources:
        limits:
          memory: 1G

  # ----------------------------
  # [NEW] RPC Proxy (Fixes CORS/MetaMask)
  # ----------------------------
  rpc-proxy:
    build: ./nginx
    expose:
      - "80" # This is important for Coolify
    depends_on:
      - geth
    restart: always

  # ----------------------------
  # 2. Explorer (Alethio Lite)
  # ----------------------------
  explorer:
    image: alethio/ethereum-lite-explorer:latest
    restart: always
    environment:
      # Point browser to the public HTTPS RPC URL
      - APP_NODE_URL=https://rpc.blockchain.akadal.tr
    ports:
      - "4000:80"
    expose:
      - "80"

  # ----------------------------
  # 3. Faucet
  # ----------------------------
  faucet:
    build: ./faucet
    restart: always
    environment:
      - RPC_URL=http://geth:8545
      - PORT=3000
    ports:
      - "3000:3000"
    expose:
      - "3000"
    depends_on:
      - geth
    deploy:
      resources:
        limits:
          memory: 256M

volumes:
  geth_data:
